{"version":3,"file":"resolver.spec.js","sourceRoot":"","sources":["../../src/test/resolver.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import { context, ExecutionContext, expect, TestInterface } from './testlib';\nimport {\n  ctxTsNode,\n  isOneOf,\n  resetNodeEnvironment,\n  ts,\n  tsSupportsMtsCtsExtensions,\n  tsSupportsStableNodeNextNode16,\n} from './helpers';\nimport { project as fsProject, Project as FsProject } from '@TypeStrong/fs-fixture-builder';\nimport { join } from 'path';\nimport * as semver from 'semver';\nimport { padStart } from 'lodash';\nimport _ = require('lodash');\nimport { pathToFileURL } from 'url';\nimport type { RegisterOptions } from '..';\nimport * as fs from 'fs';\nimport * as Path from 'path';\n\n/*\n * Each test case is a separate TS project, with a different permutation of\n * project options.  The project is written to disc, then ts-node is installed,\n * then several entrypoint-* files are imported to test our resolver.\n *\n * High-level structure of these tests:\n *   package.json, tsconfig.json, src/, and out/\n *   entrypoint-* files are the entrypoints\n *   they import a bunch of target files / directories / node_modules\n *\n * The heart of this test is every time an entrypoint imports a target.\n * We are testing if the resolver figures out the correct target file to import.\n *\n * To better understand the emitted projects, run the tests, then look in `tests/tmp/resolver-*`\n *\n * Whenever a test fails, the error will log a command you can paste into your terminal to re-run\n * that project *outside* of this test suite.  This may be helpful in understanding and debugging\n * these tests.\n */\n\n// Test a bunch of permutations of:\n\n// import permutations:\n\n//   - [x] Relative import of file\n//   - [x] Relative import of index\n//   - [x] rootless library import of main\n//   - [x] rootless library import of index\n//   - [x] rootless library import of exports sub-path\n//   - [x] rootless self-import of main\n//   - [x] rootless self-import of index\n//   - [x] rootless self-import of exports sub-path\n\n//     - [x] Require with extension\n//     - [x] Require without extension\n\n//     - Require from dist to dist\n//     - Require from dist to src\n//     - Require from src to dist\n//     - [x] Require from src to src\n\n// lib permutations:\n\n//   - [x] module exists in both src and dist (precompilation ran)\n//   - [x] module exists in only dist (came from elsewhere)\n//   - [x] module exists only in src (did not precompile)\n\n//   - .ts / .js extension\n//   - .tsx / .js extension\n//   - .cts / .cjs extension\n//   - .mts / .mjs extension\n//   - .js / .js extension\n//   - .jsx / .js extension\n//   - .cjs / .cjs extension\n//   - .mjs / .mjs extension\n\n// Side-step compiler transformation of import() into require()\nconst dynamicImport = new Function('specifier', 'return import(specifier)');\n// For some reason `new Function` was triggering what *might* be a node bug,\n// where `context.parentURL` passed into loader `resolve()` was wrong.\n// eval works for unknown reasons.  This may change in future node releases.\nconst declareDynamicImportFunction = `const dynamicImport = eval('(specifier) => import(specifier)');`;\n\nconst test = context(ctxTsNode);\ntype Test = TestInterface<ctxTsNode.Ctx>;\ntype T = ExecutionContext<ctxTsNode.Ctx>;\n\nconst projectSeq = seqGenerator();\nconst entrypointSeq = seqGenerator();\nconst targetSeq = seqGenerator();\n\ninterface Project {\n  identifier: string;\n  allowJs: boolean;\n  preferSrc: boolean;\n  typeModule: boolean;\n  /** Use TS's new module: `nodenext` option */\n  useTsNodeNext: boolean;\n  experimentalSpecifierResolutionNode: boolean;\n  skipIgnore: boolean;\n}\ninterface EntrypointPermutation {\n  entrypointExt: 'cjs' | 'mjs';\n  withExt: boolean;\n  entrypointLocation: 'src' | 'out';\n  entrypointTargetting: 'src' | 'out';\n}\ntype Entrypoint = string;\ninterface GenerateTargetOptions {\n  inSrc: boolean;\n  inOut: boolean;\n  srcExt: string;\n  /** If true, is an index.* file within a directory */\n  isIndex: boolean;\n  targetPackageStyle: TargetPackageStyle;\n  packageTypeModule: boolean;\n}\ninterface Target {\n  targetIdentifier: string;\n  outName: string;\n  srcName: string;\n  srcExt: string;\n  outExt: string;\n  inSrc: boolean;\n  inOut: boolean;\n  /** If true, is neither an index.* nor a package */\n  isNamedFile: boolean;\n  /** If true, is an index.* file within a directory */\n  isIndex: boolean;\n  /** If true, should be imported as an npm package, not relative import */\n  isPackage: boolean;\n  packageStyle: TargetPackageStyle;\n  typeModule: boolean;\n}\n\n/** When target is actually a mini node_modules package */\ntype TargetPackageStyle = typeof targetPackageStyles[number];\nconst targetPackageStyles = [\n  false,\n  // test that the package contains /index.*\n  'empty-manifest',\n  // \"main\": \"src/target.<ext>\"\n  'main-src-with-extension',\n  // \"main\": \"src/target.<output ext>\"\n  'main-src-with-out-extension',\n  // \"main\": \"out/target.<output ext>\"\n  'main-out-with-extension',\n  // \"main\": \"src/target\"\n  'main-src-extensionless',\n  // \"main\": \"out/target\"\n  'main-out-extensionless',\n  // \"exports\": {\".\": \"src/target.<ext>\"}\n  'exports-src-with-extension',\n  // \"exports\": {\".\": \"src/target.<output ext>\"}\n  'exports-src-with-out-extension',\n  // \"exports\": {\".\": \"out/target.<output ext>\"}\n  'exports-out-with-extension',\n] as const;\n\ntest.suite('Resolver hooks', (test) => {\n  test.serial();\n  test.if(tsSupportsMtsCtsExtensions);\n\n  //\n  // Generate all permutations of projects\n  //\n  for (const preferSrc of [false, true]) {\n    for (const typeModule of [false, true]) {\n      for (const allowJs of [false, true]) {\n        for (const useTsNodeNext of [false, true]) {\n          // TODO test against skipIgnore: false, where imports of third-party deps in `node_modules` should not get our mapping behaviors\n          for (const skipIgnore of [/*false, */ true]) {\n            for (const experimentalSpecifierResolutionNode of [false, true]) {\n              let identifier = `resolver-${projectSeq()}`;\n              identifier += preferSrc ? '-preferSrc' : '-preferOut';\n              identifier += typeModule ? '-typeModule' : '-typeCjs---';\n              identifier += allowJs ? '-allowJs' : '--------';\n              identifier += useTsNodeNext ? '-useTsNodenext' : '--------------';\n              identifier += skipIgnore ? '-skipIgnore' : '-----------';\n              identifier += experimentalSpecifierResolutionNode ? '-experimentalSpecifierResolutionNode' : '';\n\n              const project: Project = {\n                identifier,\n                allowJs,\n                preferSrc,\n                typeModule,\n                useTsNodeNext,\n                experimentalSpecifierResolutionNode,\n                skipIgnore,\n              };\n              declareProject(test, project);\n            }\n          }\n        }\n      }\n    }\n  }\n});\n\nfunction declareProject(_test: Test, project: Project) {\n  const test = project.useTsNodeNext && !tsSupportsStableNodeNextNode16 ? _test.skip : _test;\n  test(`${project.identifier}`, async (t) => {\n    t.teardown(() => {\n      resetNodeEnvironment();\n    });\n\n    const p = fsProject(project.identifier);\n    p.rm();\n\n    p.addJsonFile('package.json', {\n      type: project.typeModule ? 'module' : undefined,\n    });\n    p.addJsonFile('tsconfig.json', {\n      'ts-node': {\n        experimentalResolver: true,\n        preferTsExts: project.preferSrc,\n        transpileOnly: true,\n        experimentalSpecifierResolution: project.experimentalSpecifierResolutionNode ? 'node' : undefined,\n        skipIgnore: project.skipIgnore,\n      } as RegisterOptions,\n      compilerOptions: {\n        allowJs: project.allowJs,\n        skipLibCheck: true,\n        // TODO add nodenext permutation\n        module: project.useTsNodeNext ? 'NodeNext' : project.typeModule ? 'esnext' : 'commonjs',\n        jsx: 'react',\n        target: 'esnext',\n      },\n    });\n\n    const targets = generateTargets(project, p);\n    const entrypoints = generateEntrypoints(project, p, targets);\n    p.write();\n    await execute(t, p, entrypoints);\n  });\n}\n\n//\n// Generate all target-* files\n//\nfunction generateTargets(project: Project, p: FsProject) {\n  /** Array of metadata about target files to be imported */\n  const targets: Array<Target> = [];\n  // TODO does allowJs matter?\n  for (const inOut of [false, true]) {\n    for (const inSrc of [false, true]) {\n      for (const srcExt of ['ts', 'tsx', 'cts', 'mts', 'jsx', 'js', 'cjs', 'mjs']) {\n        for (const targetPackageStyle of targetPackageStyles) {\n          const packageTypeModulePermutations = targetPackageStyle ? [true, false] : [project.typeModule];\n          for (const packageTypeModule of packageTypeModulePermutations) {\n            const isIndexPermutations = targetPackageStyle ? [false] : [true, false];\n            // TODO test main pointing to a directory containing an `index.` file?\n            for (const isIndex of isIndexPermutations) {\n              //#region SKIPPING\n              if (!inSrc && !inOut) continue;\n\n              // Don't bother with jsx if we don't have allowJs enabled\n              // TODO Get rid of this?  \"Just work\" in this case?\n              if (srcExt === 'jsx' && !project.allowJs) continue;\n              // Don't bother with src-only extensions when only emitting to `out`\n              if (!inSrc && ['ts', 'tsx', 'cts', 'mts', 'jsx'].includes(srcExt)) continue;\n\n              // TODO re-enable with src <-> out mapping\n              if (\n                !inOut &&\n                isOneOf(targetPackageStyle, [\n                  'main-out-with-extension',\n                  'main-out-extensionless',\n                  'exports-out-with-extension',\n                ])\n              )\n                continue;\n              if (\n                !inSrc &&\n                isOneOf(targetPackageStyle, [\n                  'main-src-with-extension',\n                  'main-src-extensionless',\n                  'exports-src-with-extension',\n                ])\n              )\n                continue;\n              if (\n                isOneOf(targetPackageStyle, [\n                  'main-out-with-extension',\n                  'main-out-extensionless',\n                  'exports-out-with-extension',\n                ])\n              )\n                continue;\n              //#endregion\n\n              targets.push(\n                generateTarget(project, p, {\n                  inSrc,\n                  inOut,\n                  srcExt,\n                  targetPackageStyle,\n                  packageTypeModule,\n                  isIndex,\n                })\n              );\n            }\n          }\n        }\n      }\n    }\n  }\n  return targets;\n}\n\nfunction generateTarget(project: Project, p: FsProject, options: GenerateTargetOptions) {\n  const { inSrc, inOut, srcExt, targetPackageStyle, packageTypeModule, isIndex } = options;\n\n  const outExt = srcExt.replace('ts', 'js').replace('x', '');\n  let targetIdentifier = `target-${targetSeq()}-${inOut && inSrc ? 'inboth' : inOut ? 'onlyout' : 'onlysrc'}-${srcExt}`;\n\n  if (targetPackageStyle)\n    targetIdentifier = `${targetIdentifier}-${targetPackageStyle}-${packageTypeModule ? 'module' : 'commonjs'}`;\n  let prefix = targetPackageStyle ? `node_modules/${targetIdentifier}/` : '';\n  let suffix = targetPackageStyle === 'empty-manifest' ? 'index' : targetPackageStyle ? 'target' : targetIdentifier;\n  if (isIndex) suffix += '-dir/index';\n  const srcDirInfix = targetPackageStyle === 'empty-manifest' ? '' : 'src/';\n  const outDirInfix = targetPackageStyle === 'empty-manifest' ? '' : 'out/';\n  const srcName = `${prefix}${srcDirInfix}${suffix}.${srcExt}`;\n  const srcDirOutExtName = `${prefix}${srcDirInfix}${suffix}.${outExt}`;\n  const outName = `${prefix}${outDirInfix}${suffix}.${outExt}`;\n  const selfImporterCjsName = `${prefix}self-import-cjs.cjs`;\n  const selfImporterMjsName = `${prefix}self-import-mjs.mjs`;\n  const target: Target = {\n    targetIdentifier,\n    srcName,\n    outName,\n    srcExt,\n    outExt,\n    inSrc,\n    inOut,\n    isNamedFile: !isIndex && !targetPackageStyle,\n    isIndex,\n    isPackage: !!targetPackageStyle,\n    packageStyle: targetPackageStyle,\n    typeModule: packageTypeModule,\n  };\n  const { isMjs: targetIsMjs } = fileInfo('.' + srcExt, packageTypeModule, project.allowJs);\n  function targetContent(loc: string) {\n    let content = '';\n    if (targetIsMjs) {\n      content += String.raw`\n        const {fileURLToPath} = await import('url');\n        const filenameNative = fileURLToPath(import.meta.url);\n        export const directory = filenameNative.replace(/.*[\\\\\\/](.*?)[\\\\\\/]/, '$1');\n        export const filename = filenameNative.replace(/.*[\\\\\\/]/, '');\n        export const targetIdentifier = '${targetIdentifier}';\n        export const ext = filenameNative.replace(/.*\\./, '');\n        export const loc = '${loc}';\n      `;\n    } else {\n      content += String.raw`\n        const filenameNative = __filename;\n        exports.filename = filenameNative.replace(/.*[\\\\\\/]/, '');\n        exports.directory = filenameNative.replace(/.*[\\\\\\/](.*?)[\\\\\\/].*/, '$1');\n        exports.targetIdentifier = '${targetIdentifier}';\n        exports.ext = filenameNative.replace(/.*\\./, '');\n        exports.loc = '${loc}';\n      `;\n    }\n    return content;\n  }\n  if (inOut) {\n    p.addFile(outName, targetContent('out'));\n    // TODO so we can test multiple file extensions in a single directory, preferTsExt\n    p.addFile(srcDirOutExtName, targetContent('out'));\n  }\n  if (inSrc) {\n    p.addFile(srcName, targetContent('src'));\n  }\n  if (targetPackageStyle) {\n    const selfImporterIsCompiled = project.allowJs;\n    const cjsSelfImporterMustUseDynamicImportHack = !project.useTsNodeNext && selfImporterIsCompiled && targetIsMjs;\n    p.addFile(\n      selfImporterCjsName,\n      targetIsMjs\n        ? cjsSelfImporterMustUseDynamicImportHack\n          ? `${declareDynamicImportFunction}\\nmodule.exports = dynamicImport('${targetIdentifier}');`\n          : `module.exports = import(\"${targetIdentifier}\");`\n        : `module.exports = require(\"${targetIdentifier}\");`\n    );\n    p.addFile(\n      selfImporterMjsName,\n      `\n        export * from \"${targetIdentifier}\";\n      `\n    );\n    function writePackageJson(obj: any) {\n      p.addJsonFile(`${prefix}/package.json`, {\n        name: targetIdentifier,\n        type: packageTypeModule ? 'module' : undefined,\n        ...obj,\n      });\n    }\n    switch (targetPackageStyle) {\n      case 'empty-manifest':\n        writePackageJson({});\n        break;\n      case 'exports-src-with-extension':\n        writePackageJson({\n          exports: {\n            '.': `./src/${suffix}.${srcExt}`,\n          },\n        });\n        break;\n      case 'exports-src-with-out-extension':\n        writePackageJson({\n          exports: {\n            '.': `./src/${suffix}.${outExt}`,\n          },\n        });\n        break;\n      case 'exports-out-with-extension':\n        writePackageJson({\n          exports: {\n            '.': `./out/${suffix}.${outExt}`,\n          },\n        });\n        break;\n      case 'main-src-extensionless':\n        writePackageJson({\n          main: `src/${suffix}`,\n        });\n        break;\n      case 'main-out-extensionless':\n        writePackageJson({\n          main: `out/${suffix}`,\n        });\n        break;\n      case 'main-src-with-extension':\n        writePackageJson({\n          main: `src/${suffix}.${srcExt}`,\n        });\n        break;\n      case 'main-src-with-out-extension':\n        writePackageJson({\n          main: `src/${suffix}.${outExt}`,\n        });\n        break;\n      case 'main-out-with-extension':\n        writePackageJson({\n          main: `src/${suffix}.${outExt}`,\n        });\n        break;\n      default:\n        const _assert: never = targetPackageStyle;\n    }\n  }\n  return target;\n}\n\n/**\n * Generate all entrypoint-* files\n */\nfunction generateEntrypoints(project: Project, p: FsProject, targets: Target[]) {\n  /** Array of entrypoint files to be imported during the test */\n  let entrypoints: string[] = [];\n  for (const entrypointExt of ['cjs', 'mjs'] as const) {\n    // TODO consider removing this logic; deferring to conditionals in the generateEntrypoint which emit meaningful comments\n    const withExtPermutations =\n      entrypointExt == 'mjs' && project.experimentalSpecifierResolutionNode === false ? [true] : [false, true];\n    for (const withExt of withExtPermutations) {\n      // Location of the entrypoint\n      for (const entrypointLocation of ['src', 'out'] as const) {\n        // Target of the entrypoint's import statements\n        for (const entrypointTargetting of ['src', 'out'] as const) {\n          // TODO re-enable when we have out <-> src mapping\n          if (entrypointLocation !== 'src') continue;\n          if (entrypointTargetting !== 'src') continue;\n\n          entrypoints.push(\n            generateEntrypoint(project, p, targets, {\n              entrypointExt,\n              withExt,\n              entrypointLocation,\n              entrypointTargetting,\n            })\n          );\n        }\n      }\n    }\n  }\n  return entrypoints;\n}\n\nfunction generateEntrypoint(project: Project, p: FsProject, targets: Target[], opts: EntrypointPermutation) {\n  const { entrypointExt, withExt, entrypointLocation, entrypointTargetting } = opts;\n  const entrypointFilename = `entrypoint-${entrypointSeq()}-${entrypointLocation}-to-${entrypointTargetting}${\n    withExt ? '-withext' : ''\n  }.${entrypointExt}`;\n  const { isMjs: entrypointIsMjs, isCompiled: entrypointIsCompiled } = fileInfo(\n    entrypointFilename,\n    project.typeModule,\n    project.allowJs\n  );\n  let entrypointContent = 'let mod;\\n';\n  entrypointContent += 'let testsRun = 0;\\n';\n  if (entrypointIsMjs) {\n    entrypointContent += `import assert from 'assert';\\n`;\n  } else {\n    entrypointContent += `const assert = require('assert');\\n`;\n    entrypointContent += `${declareDynamicImportFunction}\\n`;\n  }\n  entrypointContent += `async function main() {\\n`;\n\n  for (const target of targets) {\n    // TODO re-enable these when we have outDir <-> rootDir mapping\n    if (target.srcName.includes('onlyout') && entrypointTargetting === 'src') continue;\n    if (target.srcName.includes('onlysrc') && entrypointTargetting === 'out') continue;\n\n    const {\n      ext: targetSrcExt,\n      isMjs: targetIsMjs,\n      isCompiled: targetIsCompiled,\n    } = fileInfo(target.srcName, target.typeModule, project.allowJs);\n\n    let targetExtPermutations = [''];\n    if (!target.isPackage) {\n      if (entrypointTargetting === 'out' && target.outExt !== target.srcExt) {\n        // TODO re-enable when we have out <-> src mapping\n        targetExtPermutations = [target.outExt];\n      } else if (target.srcExt !== target.outExt) {\n        targetExtPermutations = [target.srcExt, target.outExt];\n      } else {\n        targetExtPermutations = [target.srcExt];\n      }\n    }\n    const externalPackageSelfImportPermutations = target.isPackage ? [false, true] : [false];\n    for (const targetExt of targetExtPermutations) {\n      for (const externalPackageSelfImport of externalPackageSelfImportPermutations) {\n        entrypointContent += `\\n// ${target.targetIdentifier}`;\n        if (target.isPackage) {\n          entrypointContent += ` node_modules package`;\n          if (externalPackageSelfImport) {\n            entrypointContent += ` self-import`;\n          }\n        } else {\n          entrypointContent += `.${targetExt}`;\n        }\n        entrypointContent += '\\n';\n\n        // should specifier be relative or absolute?\n        let specifier: string;\n        if (externalPackageSelfImport) {\n          specifier = `../node_modules/${target.targetIdentifier}/self-import-${entrypointExt}.${entrypointExt}`;\n        } else if (target.isPackage) {\n          specifier = target.targetIdentifier;\n        } else {\n          if (entrypointTargetting === entrypointLocation) specifier = './';\n          else specifier = `../${entrypointTargetting}/`;\n          specifier += target.targetIdentifier;\n          if (target.isIndex) specifier += '-dir';\n          if (!target.isIndex && withExt) specifier += '.' + targetExt;\n        }\n\n        //#region SKIPPING\n        if (target.isNamedFile && !withExt) {\n          // Do not try to import cjs/cts without extension; node always requires these extensions\n          if (target.outExt === 'cjs') {\n            entrypointContent += `// skipping ${specifier} because we cannot omit extension from cjs / cts files; node always requires them\\n`;\n            continue;\n          }\n          // Do not try to import mjs/mts unless experimental-specifier-resolution is turned on\n          if (target.outExt === 'mjs' && !project.experimentalSpecifierResolutionNode) {\n            entrypointContent += `// skipping ${specifier} because we cannot omit extension from mjs/mts unless experimental-specifier-resolution=node\\n`;\n            continue;\n          }\n          // Do not try to import anything extensionless via ESM loader unless experimental-specifier-resolution is turned on\n          if ((targetIsMjs || entrypointIsMjs) && !project.experimentalSpecifierResolutionNode) {\n            entrypointContent += `// skipping ${specifier} because we cannot omit extension via esm loader unless experimental-specifier-resolution=node\\n`;\n            continue;\n          }\n        }\n        if (\n          target.isPackage &&\n          isOneOf(target.packageStyle, ['empty-manifest', 'main-out-extensionless', 'main-src-extensionless']) &&\n          isOneOf(target.outExt, ['cjs', 'mjs'])\n        ) {\n          entrypointContent += `// skipping ${specifier} because it points to a node_modules package that tries to omit file extension, and node does not allow omitting cjs/mjs extension\\n`;\n          continue;\n        }\n\n        // Do not try to import a transpiled file if compiler options disagree with node's extension-based classification\n        if (!project.useTsNodeNext && targetIsCompiled) {\n          if (targetIsMjs && !project.typeModule) {\n            entrypointContent += `// skipping ${specifier} because it is compiled and compiler options disagree with node's module classification: extension=${targetSrcExt}, tsconfig module=commonjs\\n`;\n            continue;\n          }\n          if (!targetIsMjs && project.typeModule) {\n            entrypointContent += `// skipping ${specifier} because it is compiled and compiler options disagree with node's module classification: extension=${targetSrcExt}, tsconfig module=esnext\\n`;\n            continue;\n          }\n        }\n\n        // Do not try to import index from a directory if is forbidden by node's ESM resolver\n        if (target.isIndex) {\n          if ((targetIsMjs || entrypointIsMjs) && !project.experimentalSpecifierResolutionNode) {\n            entrypointContent += `// skipping ${specifier} because esm loader does not allow directory ./index imports unless experimental-specifier-resolution=node\\n`;\n            continue;\n          }\n          if (target.outExt === 'cjs') {\n            entrypointContent += `// skipping ${specifier} because it relies on node automatically resolving a directory to index.cjs/cts , but node does not support those extensions for index.* files, only .js (and equivalents), .node, .json\\n`;\n            continue;\n          }\n        }\n        //#endregion\n\n        // NOTE: if you try to explicitly import foo.ts, we will load foo.ts, EVEN IF you have `preferTsExts` off\n        const assertIsSrcOrOut = !target.inSrc\n          ? 'out'\n          : !target.inOut\n          ? 'src'\n          : project.preferSrc ||\n            (!target.isIndex && targetExt === target.srcExt && withExt) ||\n            target.srcExt === target.outExt || // <-- TODO re-enable when we have src <-> out mapping\n            (target.isPackage &&\n              isOneOf(target.packageStyle, ['main-src-with-extension', 'exports-src-with-extension']))\n          ? 'src'\n          : 'out';\n        const assertHasExt = assertIsSrcOrOut === 'src' ? target.srcExt : target.outExt;\n\n        // If entrypoint is compiled as CJS, and *not* with TS's nodenext, then TS transforms `import` into `require`,\n        // so we must hack around the compiler to get a true `import`.\n        const entrypointMustUseDynamicImportHack =\n          !project.useTsNodeNext && entrypointIsCompiled && !entrypointIsMjs && !externalPackageSelfImport;\n        entrypointContent +=\n          entrypointExt === 'cjs' && (externalPackageSelfImport || !targetIsMjs)\n            ? `  mod = await require('${specifier}');\\n`\n            : entrypointMustUseDynamicImportHack\n            ? `  mod = await dynamicImport('${specifier}');\\n`\n            : `  mod = await import('${specifier}');\\n`;\n        entrypointContent += `  assert.equal(mod.loc, '${assertIsSrcOrOut}');\\n`;\n        entrypointContent += `  assert.equal(mod.targetIdentifier, '${target.targetIdentifier}');\\n`;\n        entrypointContent += `  assert.equal(mod.ext, '${assertHasExt}');\\n`;\n        entrypointContent += `  testsRun++;\\n`;\n      }\n    }\n  }\n  entrypointContent += `}\\n`;\n  entrypointContent += `const result = main().then(() => {return testsRun});\\n`;\n  entrypointContent += `result.mark = 'marked';\\n`;\n  if (entrypointIsMjs) {\n    entrypointContent += `export {result};\\n`;\n  } else {\n    entrypointContent += `exports.result = result;\\n`;\n  }\n  p.dir(entrypointLocation).addFile(entrypointFilename, entrypointContent);\n  return entrypointLocation + '/' + entrypointFilename;\n}\n\n/**\n * Assertions happen here\n */\nasync function execute(t: T, p: FsProject, entrypoints: Entrypoint[]) {\n  //\n  // Install ts-node and try to import all the index-* files\n  //\n\n  const service = t.context.tsNodeUnderTest.register({\n    projectSearchDir: p.cwd,\n  });\n  process.__test_setloader__(t.context.tsNodeUnderTest.createEsmHooks(service));\n\n  for (const entrypoint of entrypoints) {\n    t.log(`Importing ${join(p.cwd, entrypoint)}`);\n    try {\n      const { result } = await dynamicImport(pathToFileURL(join(p.cwd, entrypoint)));\n      expect(result).toBeInstanceOf(Promise);\n      expect(result.mark).toBe('marked');\n      const testsRun = await result;\n      t.log(`Entrypoint ran ${testsRun} tests.`);\n    } catch (e) {\n      try {\n        const launchJsonPath = Path.resolve(__dirname, '../../.vscode/launch.json');\n        const launchJson = JSON.parse(fs.readFileSync(launchJsonPath, 'utf8'));\n        const config = launchJson.configurations.find((c: any) => c.name === 'Debug resolver test');\n        config.cwd = Path.join('${workspaceFolder}', Path.relative(Path.resolve(__dirname, '../..'), p.cwd));\n        config.program = `./${entrypoint}`;\n        fs.writeFileSync(launchJsonPath, JSON.stringify(launchJson, null, 2));\n      } catch {}\n      throw new Error(\n        [\n          (e as Error).message,\n          (e as Error).stack,\n          '',\n          'This is an error in a resolver test. It might be easier to investigate by running outside of the test suite.',\n          'To do that, try pasting this into your bash shell (windows invocation will be similar but maybe not identical):',\n          `    ( cd ${p.cwd} ; node --loader ../../../esm.mjs ./${entrypoint} )`,\n        ].join('\\n')\n      );\n    }\n  }\n}\n\nfunction fileInfo(filename: string, typeModule: boolean, allowJs: boolean) {\n  const ext = filename.match(/\\.(.*)$/)?.[1] ?? filename;\n  // ['ts', 'tsx', 'cts', 'mts', 'js', 'jsx', 'cjs', 'mjs']\n  return {\n    ext,\n    isMjs: ['mts', 'mjs'].includes(ext) ? true : ['cts', 'cjs'].includes(ext) ? false : typeModule,\n    isCompiled: allowJs || ['ts', 'tsx', 'jsx', 'mts', 'cts'].includes(ext),\n  };\n}\n\nfunction seqGenerator() {\n  let next = 0;\n  return function () {\n    return padStart('' + next++, 4, '0');\n  };\n}\n"]}