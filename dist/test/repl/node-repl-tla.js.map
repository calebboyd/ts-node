{"version":3,"file":"node-repl-tla.js","sourceRoot":"","sources":["../../../src/test/repl/node-repl-tla.ts"],"names":[],"mappings":"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","sourcesContent":["import { expect } from 'chai';\nimport type { Key } from 'readline';\nimport { Stream } from 'stream';\nimport semver = require('semver');\nimport { ts } from '../helpers';\nimport type { ContextWithTsNodeUnderTest } from './helpers';\n\ninterface SharedObjects extends ContextWithTsNodeUnderTest {\n  TEST_DIR: string;\n}\n\n// Based on https://github.com/nodejs/node/blob/88799930794045795e8abac874730f9eba7e2300/test/parallel/test-repl-top-level-await.js\nexport async function upstreamTopLevelAwaitTests({\n  TEST_DIR,\n  tsNodeUnderTest,\n}: SharedObjects) {\n  const PROMPT = 'await repl > ';\n\n  const putIn = new REPLStream();\n  const replService = tsNodeUnderTest.createRepl({\n    // @ts-ignore\n    stdin: putIn,\n    // @ts-ignore\n    stdout: putIn,\n    // @ts-ignore\n    stderr: putIn,\n  });\n  const service = tsNodeUnderTest.create({\n    ...replService.evalAwarePartialHost,\n    project: `${TEST_DIR}/tsconfig.json`,\n    experimentalReplAwait: true,\n    transpileOnly: true,\n    compilerOptions: {\n      target: semver.gte(ts.version, '3.0.1')\n        ? 'es2018'\n        : // TS 2.7 is using polyfill for async interator even though they\n          // were added in es2018\n          'esnext',\n    },\n  });\n  replService.setService(service);\n  (replService.stdout as NodeJS.WritableStream & {\n    isTTY: boolean;\n  }).isTTY = true;\n  const replServer = replService.startInternal({\n    prompt: PROMPT,\n    terminal: true,\n    useColors: true,\n    useGlobal: false,\n  });\n\n  function runAndWait(cmds: Array<string | Key>) {\n    const promise = putIn.wait();\n    for (const cmd of cmds) {\n      if (typeof cmd === 'string') {\n        putIn.run([cmd]);\n      } else {\n        replServer.write('', cmd);\n      }\n    }\n    return promise;\n  }\n\n  runAndWait([\n    'function foo(x) { return x; }',\n    'function koo() { return Promise.resolve(4); }',\n  ]);\n\n  const testCases = [\n    ['await Promise.resolve(0)', '0'],\n\n    // issue: { a: await Promise.resolve(1) } is being interpreted as a block\n    // remove surrounding parenthesis once issue is fixed\n    ['({ a: await Promise.resolve(1) })', '{ a: 1 }'],\n\n    ['_', '{ a: 1 }'],\n    ['let { aa, bb } = await Promise.resolve({ aa: 1, bb: 2 }), f = 5;'],\n    ['aa', '1'],\n    ['bb', '2'],\n    ['f', '5'],\n    ['let cc = await Promise.resolve(2)'],\n    ['cc', '2'],\n    ['let dd;'],\n    ['dd'],\n    ['let [ii, { abc: { kk } }] = [0, { abc: { kk: 1 } }];'],\n    ['ii', '0'],\n    ['kk', '1'],\n    ['var ll = await Promise.resolve(2);'],\n    ['ll', '2'],\n    ['foo(await koo())', '4'],\n    ['_', '4'],\n    ['const m = foo(await koo());'],\n    ['m', '4'],\n\n    // issue: REPL doesn't recognize end of input\n    // compile is returning TS1005 after second line even though\n    // it's valid syntax\n    // [\n    //   'const n = foo(await\\nkoo());',\n    //   ['const n = foo(await\\r', '... koo());\\r', 'undefined'],\n    // ],\n\n    [\n      '`status: ${(await Promise.resolve({ status: 200 })).status}`',\n      \"'status: 200'\",\n    ],\n    ['for (let i = 0; i < 2; ++i) await i'],\n    ['for (let i = 0; i < 2; ++i) { await i }'],\n    ['await 0', '0'],\n    ['await 0; function foo() {}'],\n    ['foo', '[Function: foo]'],\n    ['class Foo {}; await 1;', '1'],\n\n    [\n      'Foo',\n      // Adjusted since ts-node supports older versions of node\n      semver.gte(process.version, '12.18.0')\n        ? '[class Foo]'\n        : '[Function: Foo]',\n    ],\n    ['if (await true) { function fooz() {}; }'],\n    ['fooz', '[Function: fooz]'],\n    ['if (await true) { class Bar {}; }'],\n\n    [\n      'Bar',\n      // Adjusted since ts-node supports older versions of node\n      semver.gte(process.version, '12.16.0')\n        ? 'Uncaught ReferenceError: Bar is not defined'\n        : 'ReferenceError: Bar is not defined',\n      // Line increased due to TS added lines\n      {\n        line: semver.gte(process.version, '12.16.0') ? 4 : 5,\n      },\n    ],\n\n    ['await 0; function* gen(){}'],\n    ['for (var i = 0; i < 10; ++i) { await i; }'],\n    ['i', '10'],\n    ['for (let j = 0; j < 5; ++j) { await j; }'],\n\n    [\n      'j',\n      // Adjusted since ts-node supports older versions of node\n      semver.gte(process.version, '12.16.0')\n        ? 'Uncaught ReferenceError: j is not defined'\n        : 'ReferenceError: j is not defined',\n      // Line increased due to TS added lines\n      {\n        line: semver.gte(process.version, '12.16.0') ? 4 : 5,\n      },\n    ],\n\n    ['gen', '[GeneratorFunction: gen]'],\n\n    [\n      'return 42; await 5;',\n      // Adjusted since ts-node supports older versions of node\n      semver.gte(process.version, '12.16.0')\n        ? 'Uncaught SyntaxError: Illegal return statement'\n        : 'SyntaxError: Illegal return statement',\n      // Line increased due to TS added lines\n      {\n        line: semver.gte(process.version, '12.16.0') ? 4 : 5,\n      },\n    ],\n\n    ['let o = await 1, p'],\n    ['p'],\n    ['let q = 1, s = await 2'],\n    ['s', '2'],\n    [\n      'for await (let i of [1,2,3]) console.log(i)',\n      [\n        'for await (let i of [1,2,3]) console.log(i)\\r',\n        '1',\n        '2',\n        '3',\n        'undefined',\n      ],\n    ],\n\n    // issue: REPL is expecting more input to finish execution\n    // compiler is returning TS1003 error\n    // [\n    //   'await Promise..resolve()',\n    //   [\n    //     'await Promise..resolve()\\r',\n    //     'Uncaught SyntaxError: ',\n    //     'await Promise..resolve()',\n    //     '              ^',\n    //     '',\n    //     \"Unexpected token '.'\",\n    //   ],\n    // ],\n\n    [\n      'for (const x of [1,2,3]) {\\nawait x\\n}',\n      ['for (const x of [1,2,3]) {\\r', '... await x\\r', '... }\\r', 'undefined'],\n    ],\n    [\n      'for (const x of [1,2,3]) {\\nawait x;\\n}',\n      [\n        'for (const x of [1,2,3]) {\\r',\n        '... await x;\\r',\n        '... }\\r',\n        'undefined',\n      ],\n    ],\n    [\n      'for await (const x of [1,2,3]) {\\nconsole.log(x)\\n}',\n      [\n        'for await (const x of [1,2,3]) {\\r',\n        '... console.log(x)\\r',\n        '... }\\r',\n        '1',\n        '2',\n        '3',\n        'undefined',\n      ],\n    ],\n    [\n      'for await (const x of [1,2,3]) {\\nconsole.log(x);\\n}',\n      [\n        'for await (const x of [1,2,3]) {\\r',\n        '... console.log(x);\\r',\n        '... }\\r',\n        '1',\n        '2',\n        '3',\n        'undefined',\n      ],\n    ],\n  ] as const;\n\n  for (const [\n    input,\n    expected = [`${input}\\r`],\n    options = {} as { line?: number },\n  ] of testCases) {\n    const toBeRun = input.split('\\n');\n    const lines = await runAndWait(toBeRun);\n    if (Array.isArray(expected)) {\n      if (expected.length === 1) expected.push('undefined');\n      if (lines[0] === input) lines.shift();\n      expect(lines).to.eqls([...expected, PROMPT]);\n    } else if ('line' in options) {\n      expect(lines[toBeRun.length + options.line!]).to.eqls(expected);\n    } else {\n      const echoed = toBeRun.map((a, i) => `${i > 0 ? '... ' : ''}${a}\\r`);\n      expect(lines).to.eqls([...echoed, expected, PROMPT]);\n    }\n  }\n}\n\n// copied from https://github.com/nodejs/node/blob/88799930794045795e8abac874730f9eba7e2300/lib/internal/util/inspect.js#L220-L227\n// Regex used for ansi escape code splitting\n// Adopted from https://github.com/chalk/ansi-regex/blob/HEAD/index.js\n// License: MIT, authors: @sindresorhus, Qix-, arjunmehta and LitoMore\n// Matches all ansi escape code sequences in a string\nconst ansiPattern =\n  '[\\\\u001B\\\\u009B][[\\\\]()#;?]*' +\n  '(?:(?:(?:[a-zA-Z\\\\d]*(?:;[-a-zA-Z\\\\d\\\\/#&.:=?%@~_]*)*)?\\\\u0007)' +\n  '|(?:(?:\\\\d{1,4}(?:;\\\\d{0,4})*)?[\\\\dA-PR-TZcf-ntqry=><~]))';\nconst ansi = new RegExp(ansiPattern, 'g');\n\n// copied from https://github.com/nodejs/node/blob/88799930794045795e8abac874730f9eba7e2300/lib/internal/util/inspect.js#L2112-L2117\n/**\n * Remove all VT control characters. Use to estimate displayed string width.\n */\nfunction stripVTControlCharacters(str: string) {\n  return str.replace(ansi, '');\n}\n\n// copied from https://github.com/nodejs/node/blob/88799930794045795e8abac874730f9eba7e2300/test/parallel/test-repl-top-level-await.js\nclass ArrayStream extends Stream {\n  readable = true;\n  writable = true;\n\n  run(data: string[]) {\n    data.forEach((line) => {\n      this.emit('data', `${line}\\n`);\n    });\n  }\n\n  pause() {}\n  resume() {}\n  write(_chunk: Buffer | string, _encoding: string, _callback: () => {}) {}\n}\n\nexport class REPLStream extends ArrayStream {\n  waitingForResponse = false;\n  lines = [''];\n\n  constructor() {\n    super();\n  }\n\n  write(chunk: Buffer | string, encoding: string, callback: () => void) {\n    if (Buffer.isBuffer(chunk)) {\n      chunk = chunk.toString(encoding);\n    }\n    const chunkLines = stripVTControlCharacters(chunk).split('\\n');\n    this.lines[this.lines.length - 1] += chunkLines[0];\n    if (chunkLines.length > 1) {\n      this.lines.push(...chunkLines.slice(1));\n    }\n    this.emit('line');\n    if (callback) callback();\n    return true;\n  }\n\n  wait(): Promise<string[]> {\n    if (this.waitingForResponse) {\n      throw new Error('Currently waiting for response to another command');\n    }\n    this.lines = [''];\n    return new Promise((resolve, reject) => {\n      const onError = (err: any) => {\n        this.removeListener('line', onLine);\n        reject(err);\n      };\n      const onLine = () => {\n        if (this.lines[this.lines.length - 1].includes('> ')) {\n          this.removeListener('error', onError);\n          this.removeListener('line', onLine);\n          resolve(this.lines);\n        }\n      };\n      this.once('error', onError);\n      this.on('line', onLine);\n    });\n  }\n}\n"]}